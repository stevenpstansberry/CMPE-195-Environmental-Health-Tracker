<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="author" content="">
	<meta name="keywords" content="adminkit, bootstrap, bootstrap 5, admin, dashboard, template, responsive, css, sass, html, theme, front-end, ui kit, web">

	<link rel="preconnect" href="https://fonts.gstatic.com">
	<link rel="shortcut icon" href="../static/img/icons/icon-48x48.png" />

	<title>Eco Health Tracker</title>

	<link href="../static/css/app.css" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
</head>

<body>
	<div class="wrapper">
		<nav id="sidebar" class="sidebar js-sidebar">
			<div class="sidebar-content js-simplebar">
				<a class="sidebar-brand" href="../dashboard">
          <span class="align-middle">Eco Health Tracker</span>
        	</a>

				<ul class="sidebar-nav">
					<li class="sidebar-header">
						Pages
					</li>

					<li class="sidebar-item active">
						<a class="sidebar-link" href="../dashboard">
              <i class="align-middle" data-feather="sliders"></i> <span class="align-middle">Dashboard</span>
            </a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="../analysis">
  				<i class="align-middle" data-feather="book"></i> <span class="align-middle">Analysis</span>
			</a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="">
              <i class="align-middle" data-feather="user"></i> <span class="align-middle">Profile</span>
            </a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="../sign_in">
              <i class="align-middle" data-feather="log-in"></i> <span class="align-middle">Sign In</span>
            </a>
					</li>

					<li class="sidebar-item">
						<a class="sidebar-link" href="../sign_up">
              <i class="align-middle" data-feather="user-plus"></i> <span class="align-middle">Sign Up</span>
            </a>
					</li>
					</li>
				</ul>
			</div>
		</nav>

		<div class="main">
			<nav class="navbar navbar-expand navbar-light navbar-bg">
				<a class="sidebar-toggle js-sidebar-toggle">
          		<i class="hamburger align-self-center"></i>
        		</a>
				<div class="navbar-collapse collapse">
					<ul class="navbar-nav navbar-align">
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle" href="#" id="alertsDropdown" data-bs-toggle="dropdown">
								<div class="position-relative">
									<i class="align-middle" data-feather="bell"></i>
									<span class="indicator">2</span>
								</div>
							</a>
							<div class="dropdown-menu dropdown-menu-lg dropdown-menu-end py-0" aria-labelledby="alertsDropdown">
								<div class="dropdown-menu-header">
									2 New Notifications
								</div>
								<div class="list-group">
									<a href="#" class="list-group-item">
										<div class="row g-0 align-items-center">
											<div class="col-2">
												<i class="text-danger" data-feather="alert-circle"></i>
											</div>
											<div class="col-10">
												<div class="text-dark">Sensor Offline</div>
												<div class="text-muted small mt-1">Please check the sensor connectivity.</div>
												<div class="text-muted small mt-1">30m ago</div>
											</div>
										</div>
									</a>
									<a href="#" class="list-group-item">
										<div class="row g-0 align-items-center">
											<div class="col-2">
												<i class="text-warning" data-feather="bell"></i>
											</div>
											<div class="col-10">
												<div class="text-dark">New Function Update</div>
												<div class="text-muted small mt-1">Check out our new function!</div>
												<div class="text-muted small mt-1">2h ago</div>
											</div>
										</div>
									</a>
								</div>
								<div class="dropdown-menu-footer">
									<a href="#" class="text-muted">Show all notifications</a>
								</div>
							</div>
						</li>
						<li class="nav-item dropdown">
							<a class="nav-icon dropdown-toggle d-inline-block d-sm-none" href="#" data-bs-toggle="dropdown">
                <i class="align-middle" data-feather="settings"></i>
              </a>

							<a class="nav-link dropdown-toggle d-none d-sm-inline-block" href="#" data-bs-toggle="dropdown">
                <img src="../static/img/avatars/avatar.jpg" class="avatar img-fluid rounded me-1" alt="Charles Hall" /> <span class="text-dark">Charles Hall</span>
              </a>
							<div class="dropdown-menu dropdown-menu-end">
								<a class="dropdown-item" href=""><i class="align-middle me-1" data-feather="user"></i> Profile</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href=""><i class="align-middle me-1" data-feather="settings"></i> Settings & Privacy</a>
								<a class="dropdown-item" href=""><i class="align-middle me-1" data-feather="help-circle"></i> Help Center</a>
								<div class="dropdown-divider"></div>
								<a class="dropdown-item" href="">Log out</a>
							</div>
						</li>
					</ul>
				</div>
			</nav>

			<main class="content">
				<div class="container-fluid p-0">
					<div class="container-fluid">
						<div class="row">
							<div class="col p-0">
								<h1 class="h3 mb-3"><strong>Dashboard</strong></h1>
							</div>
							<div class="col-auto">
								<p class="text-muted mb-0">Last Updated: {{ data.timestamp }}</p>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-xl-6 col-xxl-5 d-flex">
							<div class="w-100">
								<h6 class="text-muted mb-3 font-weight-bold" style="font-size: 14px; font-weight: 700;">Sensor Data (Compared to Same Time Last Day)</h6>
								<div class="row">
									<div class="col-sm-6">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Temperature (&deg;C)</h5>
													</div>

													<div class="col-auto">
														<div class="stat text-primary">
															<img
															src="../static/img/icons/temperature.svg"
															alt="Temperature"
															/>
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3" id="temperatureValue"> {{ data.temp }} </h1>
												<div class="mb-0">
													<span class="text-danger"> <i class="mdi mdi-arrow-bottom-right"></i> -3.65 </span>
													<span class="text-muted">Since last day</span>
												</div>
											</div>
										</div>
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Pressure (hPa)</h5>
													</div>

													<div class="col-auto">
														<div class="stat text-primary">
															<img
															src="../static/img/icons/pressure.svg"
															alt="Pressure"
															/>
															<!-- <i class="align-middle" data-feather="users"></i> -->
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3" id="pressureValue"> {{ data.press }} </h1>
												<div class="mb-0">
													<span class="text-success"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25 </span>
													<span class="text-muted">Since last day</span>
												</div>
											</div>
										</div>
									</div>
									<div class="col-sm-6">
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Humidity (%)</h5>
													</div>

													<div class="col-auto">
														<div class="stat text-primary">
															<img
															src="../static/img/icons/humidity.svg"
															alt="Humidity"
															/>
															<!-- <i class="align-middle" data-feather="dollar-sign"></i> -->
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3" id="humidityValue"> {{ data.hum }} </h1>
												<div class="mb-0">
													<span class="text-success"> <i class="mdi mdi-arrow-bottom-right"></i> 6.65 </span>
													<span class="text-muted">Since last day</span>
												</div>
											</div>
										</div>
										<div class="card">
											<div class="card-body">
												<div class="row">
													<div class="col mt-0">
														<h5 class="card-title">Air Quality</h5>
													</div>

													<div class="col-auto">
														<div class="stat text-primary">
															<img
															src="../static/img/icons/air quality.svg"
															alt="Air Quality"
															/>
															<!-- <i class="align-middle" data-feather="shopping-cart"></i> -->
														</div>
													</div>
												</div>
												<h1 class="mt-1 mb-3" id="airQualityValue"> {{ data.qlty }} </h1>
												<div class="mb-0">
													<span class="text-danger"> <i class="mdi mdi-arrow-bottom-right"></i> -2.25 </span>
													<span class="text-muted">Since last day</span>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>

						<div class="col-xl-6 col-xxl-7">
							<div class="d-flex justify-content-end mb-2">
							<!-- Horizontal button group -->
								<div class="btn-group btn-group-sm" role="group" aria-label="Data Name">
									<button type="button" class="btn btn-secondary active" id="temperatureBtn">Temperature</button>
									<button type="button" class="btn btn-secondary" id="humidityBtn">Humidity</button>
									<button type="button" class="btn btn-secondary" id="pressureBtn">Pressure</button>
									<button type="button" class="btn btn-secondary" id="airQualityBtn">Air Quality</button>
								</div>
							</div>
							<div class="card flex-fill w-100">
								<div class="card-header">
									<h5 class="card-title mb-2">Daily Data Movement</h5>
								</div>
								<div class="card-body py-3">
									<div class="chart chart-sm">
										<canvas id="chartjs-dashboard-line"></canvas>
									</div>
								</div>
							</div>
						</div>
					</div>

					<div class="row">
						<div class="col-12 col-md-6 col-xxl-3 d-flex order-1 order-xxl-3">
							<div class="col-sm-12 d-flex flex-column h-100">
								<div class="card flex-fill mb-4">
									<div class="card-body">
										<div class="row">
											<div class="col mt-0">
												<h5 class="card-title">Highest</h5>
											</div>
										</div>
										<h1 id="highestValue" class="mt-1 mb-3"></h1>
										<div class="mb-0">
											<span class="text-danger"> <i class="mdi mdi-arrow-bottom-right"></i> -3.65 </span>
											<span class="text-muted">Since last day</span>
										</div>
									</div>
								</div>
								<div class="card flex-fill mb-4">
									<div class="card-body">
										<div class="row">
											<div class="col mt-0">
												<h5 class="card-title">Lowest </h5>
											</div>
										</div>
										<h1 id="lowestValue" class="mt-1 mb-3"></h1>
										<div class="mb-0">
											<span class="text-success"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25 </span>
											<span class="text-muted">Since last day</span>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-12 col-md-12 col-xxl-6 d-flex order-3 order-xxl-2">
							<div class="card flex-fill w-100">
								<div class="card-header">

									<h5 class="card-title mb-0">Location</h5>
								</div>
								<div class="card-body">
									<div class="content" id="hybrid_map" style="height: 300px;"></div>
								</div>
							</div>
						</div>
						<div class="col-12 col-md-6 col-xxl-3 d-flex order-2 order-xxl-1">
							<div class="col-sm-12 d-flex flex-column h-100">
								<div class="card flex-fill mb-4">
									<div class="card-body">
										<div class="row">
											<div class="col mt-0">
												<h5 class="card-title">Dew Point (&deg;C)</h5>
											</div>

											<div class="col-auto">
												<div class="stat text-primary">
													<img
													src="../static/img/icons/dew_point.svg"
													alt="Dew Point"
													/>
												</div>
											</div>
										</div>
										<h1 class="mt-1 mb-3" id="dewPointValue"> {{ data.dew_point }} </h1>
										<div class="mb-0">
											<span class="text-danger"> <i class="mdi mdi-arrow-bottom-right"></i> -3.65 </span>
											<span class="text-muted">Since last day</span>
										</div>
									</div>
								</div>
								<div class="card flex-fill mb-4">
									<div class="card-body">
										<div class="row">
											<div class="col mt-0">
												<h5 class="card-title">Heat Index (&deg;C)</h5>
											</div>

											<div class="col-auto">
												<div class="stat text-primary">
													<img
													src="../static/img/icons/heat_index.svg"
													alt="Heat Index"
													/>
												</div>
											</div>
										</div>
										<h1 class="mt-1 mb-3" id="heatIndexValue"> {{ data.heat_index }} </h1>
										<div class="mb-0">
											<span class="text-success"> <i class="mdi mdi-arrow-bottom-right"></i> 5.25 </span>
											<span class="text-muted">Since last day</span>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>

			<footer class="footer">
				<div class="container-fluid">
					<div class="row text-muted">
						<div class="col-6 text-start">
							<p class="mb-0">
								<a class="text-muted" href="" target="_blank"><strong>Eco Health Tracker</strong></a> &copy;
							</p>
						</div>
						<div class="col-6 text-end">
							<ul class="list-inline">
								<li class="list-inline-item">
									<a class="text-muted" href="" target="_blank">Help</a>
								</li>
								<li class="list-inline-item">
									<a class="text-muted" href="" target="_blank">Terms</a>
								</li>
							</ul>
						</div>
					</div>
				</div>
			</footer>
		</div>
	</div>

	<script src="../static/js/app.js"></script>

	<script>
		function initMaps() {
			var hybridMap = {
				zoom: 16,
				center: {
					lat: 37.336333,
					lng: -121.881456
				},
				mapTypeId: google.maps.MapTypeId.HYBRID
			};
			var map = new google.maps.Map(document.getElementById("hybrid_map"), hybridMap);

			var marker = new google.maps.Marker({
					position: {
						lat: 37.336333,
						lng: -121.881456
					},
					map: map,
					title: 'Sensor Location'
			});
		}
	</script>

	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA-aWrwgr64q4b3TEZwQ0lkHI4lZK-moM4&callback=initMaps" async defer></script>

	<script>
		document.addEventListener("DOMContentLoaded", function() {
			var ctx = document.getElementById("chartjs-dashboard-line").getContext("2d");
			var gradient = ctx.createLinearGradient(0, 0, 0, 225);
			gradient.addColorStop(0, "rgba(215, 227, 244, 1)");
			gradient.addColorStop(1, "rgba(215, 227, 244, 0)");

			var chartData;
			var lineChart;
			var currentDataType = "temperature";

			fetchData();

			function updateChart(dataType, label) {
				lineChart.data.datasets[0].label = label;
				lineChart.data.datasets[0].data = chartData[dataType];
				lineChart.update();
				updateHighestLowest(dataType);
			}

			function updateHighestLowest(dataType) {
				var chartDataForType = chartData[dataType];
				var highest = Math.max.apply(null, chartDataForType).toFixed(2);
				var lowest = Math.min.apply(null, chartDataForType).toFixed(2);
				var unit = "";
				if (dataType === "temperature") {
					unit = " &deg;C";
				} else if (dataType === "humidity") {
					unit = " %";
				} else if (dataType === "pressure") {
					unit = " hPa";
				} else if (dataType === "airQuality") {
					unit = "";
				}
				document.getElementById("highestValue").innerHTML = highest + unit;
				document.getElementById("lowestValue").innerHTML = lowest + unit;
			}

			function toggleActiveButton(btnId) {
				var buttons = document.querySelectorAll(".btn-group button");
				buttons.forEach(function(btn) {
					if (btn.id === btnId) {
						btn.classList.add("active");
					} else {
						btn.classList.remove("active");
					}
				});
			}

			function updateData(newData, newDayData) {
				console.log("update")
				document.getElementById("temperatureValue").textContent = newData.temp;
				document.getElementById("humidityValue").textContent = newData.hum;
				document.getElementById("pressureValue").textContent = newData.press;
				document.getElementById("airQualityValue").textContent = newData.qlty;
				document.getElementById("dewPointValue").textContent = newData.dew_point;
				document.getElementById("heatIndexValue").textContent = newData.heat_index;

				chartData = newDayData;

				lineChart.data.datasets[0].data = chartData[currentDataType];

				var labels = [];
				chartData.timestamp.forEach(function(timestamp, index) {
					var hour = new Date(timestamp).getHours();
					var label = hour === 0 ? "12AM" : (hour < 12 ? hour + "AM" : (hour === 12 ? "12PM" : (hour - 12) + "PM"));
					if (!labels.includes(label)) {
						labels.push(label);
					}
				});
				// Check if the last timestamp falls between 11PM and 12AM
				var lastHour = new Date(chartData.timestamp[chartData.timestamp.length - 1]).getHours();
				if (lastHour === 23) {
					// Add "12AM" to the labels
					labels.push("12AM");
				};

				lineChart.data.labels = labels;
				lineChart.update();
				updateHighestLowest(currentDataType);
			}

			function fetchData() {
				fetch('/get_dashboard_data', {
					method: 'GET',
					headers: {
						'Content-Type': 'application/json'
					}
				})
				.then(response => response.json())
				.then(data => {
					updateData(data.data, data.latest_day_data);
				})
				.catch(error => {
					console.error('Error:', error);
				});
			}

			lineChart = new Chart(ctx, {
				type: "line",
				data: {
					labels: [],
					datasets: [{
						label: "Temperature (°C)",
						fill: true,
						backgroundColor: gradient,
						borderColor: window.theme.primary,
						data: []
					}]
				},
				options: {
					maintainAspectRatio: false,
					legend: {
						display: false
					},
					tooltips: {
						intersect: false
					},
					hover: {
						intersect: true
					},
					plugins: {
						filler: {
							propagate: false
						}
					},
					scales: {
						xAxes: [{
							reverse: true,
							gridLines: {
								color: "rgba(0,0,0,0.0)"
							}
						}],
						yAxes: [{
							ticks: {
								stepSize: 2
							},
							display: true,
							borderDash: [3, 3],
							gridLines: {
								color: "rgba(0,0,0,0.0)"
							}
						}]
					}
				}
			});

			document.getElementById("temperatureBtn").addEventListener("click", function() {
				currentDataType = "temperature";
				updateChart(currentDataType, "Temperature (°C)");
				toggleActiveButton("temperatureBtn");
			});

			document.getElementById("humidityBtn").addEventListener("click", function() {
				currentDataType = "humidity";
				updateChart(currentDataType, "Humidity (%)");
				toggleActiveButton("humidityBtn");
			});

			document.getElementById("pressureBtn").addEventListener("click", function() {
				currentDataType = "pressure";
				updateChart(currentDataType, "Pressure (hPa)");
				toggleActiveButton("pressureBtn");
			});

			document.getElementById("airQualityBtn").addEventListener("click", function() {
				currentDataType = "airQuality";
				updateChart(currentDataType, "Air Quality");
				toggleActiveButton("airQualityBtn");
			});

			setInterval(fetchData, 15 * 60 * 1000); // 15 min
		});
	</script>
	
</body>

</html>
